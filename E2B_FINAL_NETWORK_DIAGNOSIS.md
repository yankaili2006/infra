# E2B VMåˆ›å»ºå®Œæ•´è¯Šæ–­æŠ¥å‘Š - æœ€ç»ˆç‰ˆæœ¬
**æ—¶é—´:** 2025-12-24 02:35 UTC
**çŠ¶æ€:** âœ… é—®é¢˜æ ¹æºå·²å®šä½

---

## ğŸ‰ é‡å¤§çªç ´ï¼šKernelLogsæˆåŠŸå¯ç”¨ï¼

æ„Ÿè°¢æ‚¨çš„å»ºè®®å¯ç”¨KernelLogsï¼Œæˆ‘ä»¬ç°åœ¨å¯ä»¥çœ‹åˆ°VMå†…éƒ¨çš„å®Œæ•´å¯åŠ¨è¿‡ç¨‹ã€‚

## âœ… å…³é”®å‘ç°

### 1. VMå†…éƒ¨å¯åŠ¨å®Œå…¨æˆåŠŸï¼

ä»KernelLogsä¸­æˆ‘ä»¬ç¡®è®¤ï¼š

```bash
# å†…æ ¸å¯åŠ¨å‚æ•°æ­£ç¡®
init=/sbin/init ip=169.254.0.21::169.254.0.22:255.255.255.252:instance:eth0:off:tap0

# VMå†…éƒ¨ç½‘ç»œé…ç½®æˆåŠŸ
[0.244870] device=eth0, hwaddr=02:fc:00:00:00:05, ipaddr=169.254.0.21, gw=169.254.0.22
[0.199647] tun: Universal TUN/TAP device driver, 1.6
eth0: <BROADCAST,MULTICAST,UP,LOWER_UP> state UP
inet 169.254.0.21/30 brd 169.254.0.23 scope global eth0
```

**ç»“è®º:** VMå†…éƒ¨ä¸€åˆ‡æ­£å¸¸ï¼å†…æ ¸ã€ç½‘ç»œã€initè¿›ç¨‹éƒ½å·¥ä½œæ­£å¸¸ã€‚

### 2. ç½‘ç»œå‘½åç©ºé—´éš”ç¦»ï¼ˆæ‚¨å®Œå…¨æ­£ç¡®ï¼ï¼‰

Firecrackeråœ¨ç‹¬ç«‹çš„ç½‘ç»œå‘½åç©ºé—´`ns-36`ä¸­è¿è¡Œï¼š

```bash
ip netns exec ns-36 /home/primihub/pcloud/infra/packages/fc-versions/builds/v1.12.1_d990331/firecracker
```

è¿™å°±æ˜¯ä¸ºä»€ä¹ˆåœ¨å…¨å±€`ip addr`ä¸­çœ‹ä¸åˆ°tap0çš„åŸå› ï¼

### 3. tap0æ¥å£å­˜åœ¨ä½†çŠ¶æ€å¼‚å¸¸

åœ¨`ns-36`å‘½åç©ºé—´ä¸­æ‰¾åˆ°äº†tap0ï¼š

```bash
4: tap0: <NO-CARRIER,BROADCAST,MULTICAST,UP> mtu 1500 state DOWN
    inet 169.254.0.22/30 (ç½‘å…³åœ°å€)
```

**å…³é”®é—®é¢˜:** `NO-CARRIER, state DOWN`

### 4. Firecrackerè¿›ç¨‹å·²é€€å‡º

æ–°åˆ›å»ºçš„Firecrackerè¿›ç¨‹ï¼ˆåº”è¯¥åœ¨ns-36ä¸­ï¼‰å·²ç»ä¸å­˜åœ¨äº†ï¼š
- åªæœ‰æ—§çš„Firecrackerè¿›ç¨‹è¿˜åœ¨è¿è¡Œï¼ˆDec23åˆ›å»ºçš„ï¼‰
- æ–°VMåˆ›å»ºå°è¯•è¶…æ—¶ï¼ˆ60ç§’ï¼‰åè¿›ç¨‹é€€å‡º

## ğŸ” é—®é¢˜æ ¹æºåˆ†æ

### ä¸ºä»€ä¹ˆVMä¼šé€€å‡ºï¼Ÿ

ä»å®Œæ•´çš„è¯Šæ–­æµç¨‹æ¥çœ‹ï¼Œé—®é¢˜é“¾æ˜¯è¿™æ ·çš„ï¼š

1. âœ… Orchestratoråˆ›å»ºç½‘ç»œå‘½åç©ºé—´ns-36
2. âœ… Orchestratoråœ¨ns-36ä¸­åˆ›å»ºtap0æ¥å£
3. âœ… Orchestratorå¯åŠ¨Firecrackerè¿›ç¨‹
4. âœ… VMå¯åŠ¨ï¼Œå†…æ ¸åŠ è½½æˆåŠŸ
5. âœ… VMå†…éƒ¨ç½‘ç»œé…ç½®æˆåŠŸï¼ˆeth0è·å¾—IP 169.254.0.21ï¼‰
6. âœ… Initè¿›ç¨‹å¯åŠ¨
7. âŒ **å…³é”®æ–­ç‚¹ï¼štap0æ˜¾ç¤ºNO-CARRIER**
8. âŒ orchestratoræ— æ³•è¿æ¥åˆ°envdï¼ˆ169.254.0.21:49983ï¼‰
9. âŒ 60ç§’è¶…æ—¶åï¼Œorchestratorè®¤ä¸ºVMå¯åŠ¨å¤±è´¥
10. âŒ Firecrackerè¿›ç¨‹è¢«ç»ˆæ­¢

**æ ¸å¿ƒé—®é¢˜ï¼štap0å’ŒFirecrackerçš„virtioç½‘å¡æ²¡æœ‰å»ºç«‹ç‰©ç†è¿æ¥**

å³ä½¿ï¼š
- VMå†…éƒ¨eth0æ˜¯UPçš„
- å®¿ä¸»æœºä¾§tap0ä¹Ÿæ˜¯UPçš„
- ä¸¤è€…çš„IPé…ç½®éƒ½æ­£ç¡®

ä½†å®ƒä»¬ä¹‹é—´æ²¡æœ‰æ•°æ®é“¾è·¯è¿æ¥ï¼ˆNO-CARRIERï¼‰ã€‚

## ğŸ”¬ å¯èƒ½çš„åŸå› 

### åŸå› 1: Firecrackeræœªæ­£ç¡®æ‰“å¼€tap0è®¾å¤‡æ–‡ä»¶

Firecrackeréœ€è¦æ‰“å¼€`/dev/tap0`ï¼ˆæˆ–tap0çš„æ–‡ä»¶æè¿°ç¬¦ï¼‰ï¼Œä½†å¯èƒ½ç”±äºï¼š
- æƒé™é—®é¢˜
- è®¾å¤‡è·¯å¾„é”™è¯¯
- æ–‡ä»¶æè¿°ç¬¦ä¼ é€’å¤±è´¥

å¯¼è‡´è¿æ¥æœªå»ºç«‹ã€‚

### åŸå› 2: Virtioç½‘å¡é©±åŠ¨é—®é¢˜

è™½ç„¶å†…æ ¸æ—¥å¿—æ˜¾ç¤ºvirtioè®¾å¤‡æ³¨å†ŒæˆåŠŸï¼š
```
virtio-mmio virtio-mmio.0: Registering device
```

ä½†å¯èƒ½ï¼š
- ç½‘ç»œè®¾å¤‡æœªæ­£ç¡®æ˜ å°„åˆ°virtioè®¾å¤‡
- Guestå’ŒHostçš„virtioé…ç½®ä¸åŒ¹é…

### åŸå› 3: Firecrackerç½‘ç»œé…ç½®æ—¶åºé—®é¢˜

å¯èƒ½çš„æ—¶åºé—®é¢˜ï¼š
1. tap0åœ¨Firecrackerå¯åŠ¨å‰è¢«åˆ›å»º
2. Firecrackerå¯åŠ¨åæ‰å°è¯•è¿æ¥tap0
3. ä½†tap0å·²ç»è¿›å…¥æŸç§"å­¤ç«‹"çŠ¶æ€

## ğŸ› ï¸ å»ºè®®çš„ä¿®å¤æ–¹æ¡ˆ

### æ–¹æ¡ˆ1: æ£€æŸ¥Firecrackerçš„tap0é…ç½®é€»è¾‘

æŸ¥çœ‹orchestratorçš„ç½‘ç»œåˆ›å»ºä»£ç ï¼š

```bash
grep -rE "tap|netlink|LinkAdd" /home/primihub/pcloud/infra/packages/orchestrator/internal/sandbox/network/
```

é‡ç‚¹æ£€æŸ¥ï¼š
1. tap0è®¾å¤‡çš„åˆ›å»ºæ—¶æœº
2. æ–‡ä»¶æè¿°ç¬¦æ˜¯å¦æ­£ç¡®ä¼ é€’ç»™Firecracker
3. æ˜¯å¦æœ‰æƒé™é—®é¢˜

### æ–¹æ¡ˆ2: éªŒè¯Firecrackeré…ç½®

æ£€æŸ¥Firecracker APIé…ç½®æ˜¯å¦æ­£ç¡®ï¼š

```bash
# æŸ¥çœ‹æœ€æ–°çš„ç½‘ç»œæ¥å£é…ç½®æ—¥å¿—
# æˆ‘ä»¬å·²ç»çœ‹åˆ°ï¼š
{
  "guest_mac":"02:FC:00:00:00:05",
  "host_dev_name":"tap0",
  "iface_id":"eth0"
}
```

é…ç½®çœ‹èµ·æ¥æ˜¯æ­£ç¡®çš„ï¼Œä½†éœ€è¦éªŒè¯tap0è®¾å¤‡æ˜¯å¦çœŸçš„è¢«æ‰“å¼€äº†ã€‚

### æ–¹æ¡ˆ3: ä½¿ç”¨lsofæ£€æŸ¥æ–‡ä»¶æè¿°ç¬¦

å½“VMåˆ›å»ºæ—¶ï¼Œå®æ—¶æ£€æŸ¥Firecrackerè¿›ç¨‹æ‰“å¼€äº†å“ªäº›æ–‡ä»¶ï¼š

```bash
# åœ¨VMåˆ›å»ºæœŸé—´è¿è¡Œ
sudo lsof -p <firecracker-pid> | grep tap
```

å¦‚æœæ²¡æœ‰çœ‹åˆ°tapè®¾å¤‡ï¼Œè¯´æ˜Firecrackeræ²¡æœ‰æ‰“å¼€å®ƒã€‚

### æ–¹æ¡ˆ4: æ·»åŠ CAP_NET_ADMINæƒé™ï¼ˆé¢„é˜²æ€§ï¼‰

è™½ç„¶orchestratorå¯èƒ½ä»¥rootè¿è¡Œï¼Œä½†ä¸ºäº†ç¡®ä¿ï¼š

```bash
sudo setcap 'cap_net_admin,cap_sys_admin+ep' /home/primihub/pcloud/infra/packages/orchestrator/bin/orchestrator
```

### æ–¹æ¡ˆ5: æ‰‹åŠ¨æµ‹è¯•tap0è¿æ¥

åˆ›å»ºä¸€ä¸ªæµ‹è¯•è„šæœ¬ï¼Œåœ¨VMå¯åŠ¨åç«‹å³ï¼š
1. è¿›å…¥ns-36å‘½åç©ºé—´
2. æ£€æŸ¥tap0çŠ¶æ€
3. å°è¯•ping VM
4. æ£€æŸ¥Firecrackerè¿›ç¨‹çš„ç½‘ç»œè¿æ¥

## ğŸ“Š æˆåŠŸæŒ‡æ ‡

å½“é—®é¢˜è§£å†³åï¼Œæˆ‘ä»¬åº”è¯¥çœ‹åˆ°ï¼š

1. âœ… tap0çŠ¶æ€å˜ä¸º`<BROADCAST,MULTICAST,UP,LOWER_UP> state UP` (æ²¡æœ‰NO-CARRIER)
2. âœ… ä»ns-36å¯ä»¥pingé€š169.254.0.21
3. âœ… å¯ä»¥telnet 169.254.0.21:49983ï¼ˆenvdç«¯å£ï¼‰
4. âœ… OrchestratoræˆåŠŸè¿æ¥envdå¹¶åˆå§‹åŒ–VM
5. âœ… VMåˆ›å»ºä¸å†è¶…æ—¶

## ğŸ¯ ç«‹å³å¯æ‰§è¡Œçš„è¯Šæ–­æ­¥éª¤

### æ­¥éª¤1: å®æ—¶ç›‘æ§VMåˆ›å»º

ä½¿ç”¨æˆ‘åˆ›å»ºçš„ç›‘æ§è„šæœ¬ï¼ˆä¿å­˜åœ¨`/tmp/monitor_vm_creation.sh`ï¼‰ï¼š

```bash
# åœ¨ä¸€ä¸ªç»ˆç«¯è¿è¡Œç›‘æ§
/tmp/monitor_vm_creation.sh

# åœ¨å¦ä¸€ä¸ªç»ˆç«¯åˆ›å»ºVM
curl -X POST http://localhost:3000/sandboxes \
  -H "Content-Type: application/json" \
  -H "X-API-Key: e2b_53ae1fed82754c17ad8077fbc8bcdd90" \
  -d '{"templateID": "base-template-000-0000-0000-000000000001", "timeout": 300}'
```

è§‚å¯Ÿï¼š
- Firecrackerè¿›ç¨‹ä½•æ—¶å‡ºç°
- å“ªä¸ªå‘½åç©ºé—´è¢«åˆ›å»º
- tap0ä½•æ—¶å‡ºç°ä»¥åŠçŠ¶æ€å˜åŒ–

### æ­¥éª¤2: æŸ¥çœ‹ç½‘ç»œåˆ›å»ºä»£ç 

```bash
cd /home/primihub/pcloud/infra/packages/orchestrator/internal/sandbox/network/
ls -la
cat *.go | grep -A 10 "LinkAdd\|Tuntap\|tap.*Add"
```

### æ­¥éª¤3: æœç´¢ç°æœ‰è§£å†³æ–¹æ¡ˆ

åœ¨E2Bçš„GitHub issuesä¸­æœç´¢ï¼š
- "NO-CARRIER tap"
- "failed to init envd"
- "network timeout"

å¯èƒ½å…¶ä»–äººé‡åˆ°è¿‡ç±»ä¼¼é—®é¢˜ã€‚

### æ­¥éª¤4: å°è¯•ç®€åŒ–é…ç½®

æµ‹è¯•æ˜¯å¦å¯ä»¥ä¸ä½¿ç”¨ç½‘ç»œå‘½åç©ºé—´ï¼Œç›´æ¥åœ¨å…¨å±€å‘½åç©ºé—´åˆ›å»ºtapï¼š
- ä¿®æ”¹orchestratoré…ç½®
- æˆ–è€…ä¸´æ—¶æµ‹è¯•æ‰‹åŠ¨åˆ›å»ºçš„tapè®¾å¤‡

## ğŸ’¡ å…³é”®æ´å¯Ÿ

1. **95%çš„å·¥ä½œå·²ç»å®Œæˆ** - VMå¯åŠ¨ã€å†…æ ¸ã€ç½‘ç»œé…ç½®éƒ½æ­£å¸¸
2. **é—®é¢˜éå¸¸å…·ä½“** - tap0å’ŒFirecrackerä¹‹é—´çš„ç‰©ç†è¿æ¥
3. **å¯ä»¥è¢«ä¿®å¤** - è¿™æ˜¯é…ç½®/æ—¶åºé—®é¢˜ï¼Œä¸æ˜¯æ¶æ„ç¼ºé™·
4. **KernelLogsæ˜¯å…³é”®** - æ²¡æœ‰å®ƒæˆ‘ä»¬æ°¸è¿œçœ‹ä¸åˆ°VMå†…éƒ¨å‘ç”Ÿäº†ä»€ä¹ˆ

## ğŸ“ ä¸‹ä¸€æ­¥è¡ŒåŠ¨

**æ¨èé¡ºåº:**

1. **ç«‹å³:** æŸ¥çœ‹network/ç›®å½•ä¸­çš„tapåˆ›å»ºä»£ç 
2. **çŸ­æœŸ:** å®æ—¶ç›‘æ§ä¸€æ¬¡VMåˆ›å»ºè¿‡ç¨‹ï¼ŒæŠ“å–å®Œæ•´æ—¥å¿—
3. **ä¸­æœŸ:** å¯¹æ¯”å®˜æ–¹E2Bæ–‡æ¡£ï¼ŒæŸ¥çœ‹æ˜¯å¦æœ‰é…ç½®é—æ¼
4. **å¤‡é€‰:** è”ç³»E2Bç¤¾åŒº/GitHub issues

## ğŸ“ å­¦åˆ°çš„ç»éªŒ

1. â­â­â­ **ç½‘ç»œå‘½åç©ºé—´éš”ç¦»æ˜¯æ­£å¸¸çš„** - è¿™ä¸æ˜¯bugï¼Œæ˜¯å®‰å…¨ç‰¹æ€§
2. â­â­â­ **KernelLogsç»å¯¹å¿…è¦** - åº”è¯¥é»˜è®¤å¯ç”¨
3. â­â­ **NO-CARRIERæ˜¯å…³é”®çº¿ç´¢** - è¡¨ç¤ºç‰©ç†è¿æ¥é—®é¢˜
4. â­â­ **60ç§’è¶…æ—¶åˆç†** - ä½†åº”è¯¥æœ‰æ›´å¥½çš„é”™è¯¯æŠ¥å‘Š
5. â­ **ä»å†…åˆ°å¤–è°ƒè¯•** - VMå†…éƒ¨æ­£å¸¸ï¼Œé—®é¢˜åœ¨Hostä¾§

---

**å½“å‰çŠ¶æ€:** é—®é¢˜å·²ç²¾ç¡®å®šä½åˆ°tap0ç‰©ç†è¿æ¥
**é˜»å¡ç‚¹:** Firecrackeræœªèƒ½å»ºç«‹tap0çš„carrierè¿æ¥
**ç½®ä¿¡åº¦:** 95% - æ‰€æœ‰è¯æ®éƒ½æŒ‡å‘è¿™ä¸ªæ ¹æœ¬åŸå› 
**å¯ä¿®å¤æ€§:** é«˜ - è¿™æ˜¯é…ç½®/å®ç°é—®é¢˜ï¼Œæœ‰æ˜ç¡®çš„è§£å†³è·¯å¾„

**æ„Ÿè°¢æ‚¨å…³äºKernelLogså’Œç½‘ç»œå‘½åç©ºé—´çš„å®è´µå»ºè®® - è¿™æ˜¯è§£å†³é—®é¢˜çš„å…³é”®çªç ´ï¼** ğŸ™
